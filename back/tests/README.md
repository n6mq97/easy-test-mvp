# Тесты для Backend

Этот каталог содержит все тесты для backend приложения.

## Структура тестов

### `conftest.py`
Основной файл с фикстурами pytest:
- `db_engine` - создает тестовый движок БД
- `db_session` - создает тестовую сессию с автоматической очисткой
- `client` - создает тестовый FastAPI клиент
- `sample_section`, `sample_question`, `sample_answers` - готовые тестовые данные

### `test_models.py`
Тесты для SQLAlchemy моделей:
- Создание, чтение, обновление, удаление (CRUD) операций
- Проверка связей между моделями
- Валидация данных на уровне БД
- Тесты каскадного удаления

### `test_schemas.py`
Тесты для Pydantic схем:
- Валидация входных данных
- Проверка значений по умолчанию
- Тесты граничных случаев
- Проверка сериализации/десериализации

### `test_api.py`
Тесты для API эндпоинтов:
- HTTP запросы к реальным эндпоинтам
- Проверка статус кодов
- Валидация ответов
- Тесты с реальной базой данных

### `test_integration.py`
Интеграционные тесты:
- Полные рабочие процессы
- Тесты консистентности данных
- Проверка всего стека приложения

### `test_main.py`
Базовые тесты для основных эндпоинтов:
- Health check
- Root endpoint

## Как запустить тесты

### Локально с Docker
```bash
# Запустить PostgreSQL
docker-compose -f ../docker-compose.dev.yml up -d db

# Установить зависимости
poetry install --with dev

# Запустить миграции
poetry run alembic upgrade head

# Запустить тесты
poetry run pytest -v
```

### Через Makefile
```bash
# Тестировать только backend
make test-backend

# Тестировать CI pipeline локально
make test-ci
```

### Через скрипт CI
```bash
./scripts/test-ci.sh
```

## Особенности тестирования

### Реальная база данных
- Тесты используют реальную PostgreSQL базу данных
- Каждый тест получает чистую сессию БД
- После каждого теста данные автоматически очищаются

### Фикстуры
- `db_session` - автоматически создает и очищает таблицы
- `client` - переопределяет зависимость БД для тестов
- Готовые тестовые данные для быстрого старта

### Изоляция тестов
- Каждый тест работает в своей транзакции
- Данные не пересекаются между тестами
- Автоматическая очистка после каждого теста

## Добавление новых тестов

### Для новых моделей
1. Создайте тесты в `test_models.py`
2. Проверьте CRUD операции
3. Тестируйте связи с другими моделями

### Для новых API эндпоинтов
1. Создайте тесты в `test_api.py`
2. Используйте фикстуру `client`
3. Проверьте HTTP статусы и ответы

### Для новых схем
1. Создайте тесты в `test_schemas.py`
2. Проверьте валидацию данных
3. Тестируйте граничные случаи

## Отладка тестов

### Проблемы с БД
```bash
# Проверить статус PostgreSQL
docker exec easy-test-mvp-db-1 pg_isready -U user -d testdb

# Посмотреть логи
docker-compose -f ../docker-compose.dev.yml logs db
```

### Проблемы с зависимостями
```bash
# Переустановить зависимости
poetry install --with dev --no-cache
```

### Запуск конкретного теста
```bash
# Запустить один тест
poetry run pytest tests/test_models.py::test_create_section -v

# Запустить тесты с определенным маркером
poetry run pytest -m "slow" -v
```

